{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/parsing-creation-time-from-mp4-metadata-in-javascript","result":{"data":{"markdownRemark":{"html":"<p>Q: How to get creation time from mp4 in javascript?</p>\n<p>A: You cannot with native javascript code.</p>\n<p>A quick google search reveals <a href=\"https://stackoverflow.com/questions/37046371/obtaining-mp4-creation-time-from-html5-video\">https://stackoverflow.com/questions/37046371/obtaining-mp4-creation-time-from-html5-video</a> . This was the first result given to me from google when I searched the question above. </p>\n<p>I knew this wasn't possible from previous knowledge and also you can look here at the video spec <a href=\"https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video\">https://developer.mozilla.org/en-US/docs/Web/HTML/Element/video</a> and you can see it does not parse that type of information from the file when it is loaded. I still searched google to see if there was a good answer. </p>\n<h3>Let us break down the 4 popular answers in the stack overflow link above.</h3>\n<p><em>Includes the response to use mp4box.js</em> </p>\n<h4>1. Prepare the file on server side using a filename containing the timestamp encoded in the name. Extract the timestamp from the container by the means necessary.</h4>\n<p>This is possible, do some post processing after a file is uploaded to a server or a storage. There are some drawbacks with this is that you would need to install some software to parse and get this information maybe, ffmpeg with ffprobe. Also what happens if the file is large? Large in this article will be anything over 2GBs. You probably don't want to storage a large file on a web server or download to a microservice. You will end up having to stream the file into whatever backend post processing service you use. That is a lot of work to handle because the file originated in the client side to begin with. </p>\n<p>Overall I would aside against this unless the information isn't needed ASAP or if you have an uploading service that handles the chunked upload to your storage you could parse the stream while it is being uploaded and get it while uploading. This again requires a lot of work if you do not already have it. </p>\n<h4>2. Supply meta-file to the mp4 file containing the datestamp which is read separately from client.</h4>\n<p>I do not quite understand what this means, I don't think we should be splitting up information and have a user say what the creation time of the MP4 is. I maybe misunderstanding this option. This requires more work on the user's end to get the creation date timestamp for an MP4. They have their MP4 so we should be able to get that information from the file automatically. </p>\n<h4>3. Load the file via XMLHttpRequest and manually parse the file to find the chunk containing the data. There are some problems with this of course such as risking having to load the entire file into memory.</h4>\n<p>This is the right solution the only draw back is to if you have to read the entire file to find the metadata. Streaming the file will fix having to load the entire file into memory. This scenario assumes that the user does not have the file locally in the browser already. The method I purpose will work with this one and if the file loads the file from a input file reader too.</p>\n<h3>The scenario I had to solve</h3>\n<p>A user uses a file input file to select any number of MP4 files and they will be uploaded to my file storage. So during this process the user selects a file off their desktop and the file reader will be able to read the file into javascript memory. At this time we can parse the file for the creation date and it can be sent off to the uploader code to be uploaded to whatever server or file storage you have.</p>\n<p>Note: This article does not go into how or where you will be uploading a file. It goes into detail on how to parse an .mp4 file on clientside in javascript; do what you want with this. </p>\n<h3>4. Why I wrote my own code instead of using a library</h3>\n<p><em>In response to</em></p>\n<blockquote>\n<p>Thanks. I'll go with the 3rd option + the following lib github.com/gpac/mp4box.js to parse the moov. – galbarm May 8 '16 at 8:21</p>\n</blockquote>\n<p>It is quite difficult to find a clientside javacsript library to stream parse an exact metadata value from an mp4 video. I tried using mp4box.js <a href=\"https://github.com/gpac/mp4box.js/\">https://github.com/gpac/mp4box.js/</a> to do this. The library does parse all the metadata from the mp4 and does a great job of that but the one issue I had is I could not figure out how to stream the file through the application. </p>\n<p>Here is an example</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> MP4Box <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mp4box'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token keyword\">var</span> mp4boxfile <span class=\"token operator\">=</span> MP4Box<span class=\"token punctuation\">.</span><span class=\"token function\">createFile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> myDataExcludingTheFirstByte <span class=\"token operator\">=</span> <span class=\"token function\">myFunctionToRetrieveMP4DataWithoutFirstByte</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmp4boxfile<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onError</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nmp4boxfile<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onReady</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">info</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nmp4boxfile<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onMoovStart</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Starting to receive File Information\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nmp4boxfile<span class=\"token punctuation\">.</span><span class=\"token function\">appendBuffer</span><span class=\"token punctuation\">(</span>MyDataExcludingTheFirstByte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>After reading this code, the <code class=\"language-text\">onMoovStart</code> function will start but the <code class=\"language-text\">onReady</code> will never finish. Also if you reverse this process, if you add <code class=\"language-text\">MyDataExcludingTheLastByte</code> it will not trigger <code class=\"language-text\">onReady</code> either. From this example it means you cannot stream the data into the library to parse stream metadata. It requires you to pass literally the entire mp4 file into the library. What happens if you have a large file? That means you would have to pass an entire 8GB file to get the information. This will take several minutes. This does not solve my streaming case. </p>\n<p>To restate the issue above, you can pass the entire .mp4 file excluding the first byte or the last byte of the file and the parser will not parse the metadata. </p>\n<p>Note: There maybe other libraries that can do this in javascript but it was difficult to find libraries and once you find them you will have to test all the quirks of the library to see if it solves your very specific use case. </p>\n<h3>Enough background, here is a heuristic solution &#x26; deterministic solution</h3>\n<p>You actually get to configure this library to be a linear interpolation between the two solutions.  </p>\n<p>I propose a solution has configuration to easily and quickly parse the moov atom from an MP4 to get the creation date.</p>\n<p> MP4 files are composed of a bunch of atoms and each atom has a certain amount of information related to the MP4. The atom we are interested in is the moov atom since it has the metadata of the video. It will tell us the creation time of the mp4 video. The good and bad about mp4 atoms is they can exist anywhere inside the mp4 file format. For web optimized file formats the moov atom is stored at the front of the mp4 file for browsers and video players can parse the video content and stream the data without having to load the entire file into memory. Typically mp4 video encoders will write the moov atom to the back of the file because they can write the mp4 video in one pass when encoding the file format. These two pieces of information are important because we can use these to heuristically parse an mp4 for the moov atom and get the creation date without having to load an entire file.</p>\n<h3>Describing the drawbacks, optimizations, parameters of a mp4 parser</h3>\n<p><strong>Reiterating the original problem I am trying to solve</strong></p>\n<p>I am trying to specifically solve <em>retrieving the creation date from a large video.</em> </p>\n<p>Here are some attributes of the library</p>\n<ul>\n<li>Streams the file in chunk sizes of any size</li>\n<li>Read from the front of the file</li>\n<li>Read from the back of the file</li>\n<li>Read the entire file</li>\n<li>Max bytes read for a fail safe</li>\n</ul>\n<p>My points above allow me to control how the parser works. If I assume all the files I am parsing will have moov in the back of the file I can have my parser read only from the back and vice versa. If I knew all videos I was parsing were web optimized I would want to read from the start.</p>\n<p>If I have no idea where it would be or just want to already read the entire file you can scan the entire file at the cost of speed. I allow for chunk size reading so you can read in chunks of 1MB, 5MB, or however many MBs of the file you want to read and parse at once. Also you can specify a max bytes read parameter to kill the parser and say <em>No creation date found</em> within so many MBs. This is great for fast parsing. </p>\n<p><strong>Examples</strong></p>\n<ul>\n<li>You have an 8GB file and you assume the moov atom is at the back of the file. Setup the parser to read 5MB chunks from the back of the file and only read 100MBs of the original files backwards. This means if we read more than 100MBs trying to find the moov atom we will say that no creation date is found. I would be surprised if the moov was more than 100MBs into the file from the back if it was written in the back of the file. I think the original file would have to be massive for the metadata atom to actually be 100MBs in size. I am using this assumption to help solve my problem.</li>\n<li>If you know your files are super small you can just always read the entire file because you will not take the hit of speed since you are not reading many gigabytes.</li>\n<li>If you do not like my heuristic method you can still use the library to efficiently stream, read, and parse a video for the creation date. It will use minimal memory during this process so it can be ran without crashing in the browser on large videos.</li>\n</ul>\n<h3>Understanding the file format for MP4 to detect the creation time and how to parse it for the creation date timestamp</h3>\n<p>Here is a sample snippet of some byte ranges in a sample mp4 file to see the <code class=\"language-text\">moov</code> atom in hex.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ xxd mySample.mp4 <span class=\"token operator\">|</span> <span class=\"token function\">less</span> \n$ <span class=\"token punctuation\">..</span>.\n$ 0100b70: 3fc0 8e00 0000 086d <span class=\"token number\">6461</span> <span class=\"token number\">7400</span> 0010 7d6d  ?<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>mdat<span class=\"token punctuation\">..</span>.<span class=\"token punctuation\">}</span>m\n$ 0100b80: 6f6f <span class=\"token number\">7600</span> 0000 6c6d <span class=\"token number\">7668</span> <span class=\"token number\">6400</span> 0000 007c  oov<span class=\"token punctuation\">..</span>.lmvhd<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token operator\">|</span>\n$ 0100b90: 25b0 80cf f058 <span class=\"token number\">3100</span> 0003 e800 0014 c000  %<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>X1<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.\n$ 0100ba0: 0100 0001 0000 0000 0000 0000 0000 0000  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n$ 0100bb0: 0100 0000 0000 0000 0000 0000 0000 0000  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n$ 0100bc0: 0100 0000 0000 0000 0000 0000 0000 0040  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.@\n$ 0100bd0: 0000 0000 0000 0000 0000 0000 0000 0000  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n$ 0100be0: 0000 0000 0000 0000 0000 0000 0000 0300  <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n$ <span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>You can see the <code class=\"language-text\">moov</code> atom in text as well as <code class=\"language-text\">mvhd</code> . The moov atom contains a lot of information about the video file itself. The creation time we want exists inside the <code class=\"language-text\">mvhd</code> tag aka <code class=\"language-text\">movie (presentation) header box</code></p>\n<p>If we look at the file format in the byte layout <a href=\"http://xhelmboyx.tripod.com/formats/mp4-layout.txt\">http://xhelmboyx.tripod.com/formats/mp4-layout.txt</a></p>\n<p>We get this,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">* 8+ bytes movie (presentation) header box\n        = long unsigned offset + long ASCII text string &#39;mvhd&#39;\n      -&gt; 1 byte version = 8-bit unsigned value\n        - if version is 1 then date and duration values are 8 bytes in length\n      -&gt; 3 bytes flags =  24-bit hex flags (current = 0)\n\n      -&gt; 4 bytes created mac UTC date\n          = long unsigned value in seconds since beginning 1904 to 2040\n      -&gt; 4 bytes modified mac UTC date\n          = long unsigned value in seconds since beginning 1904 to 2040\n      OR\n      -&gt; 8 bytes created mac UTC date\n          = 64-bit unsigned value in seconds since beginning 1904\n      -&gt; 8 bytes modified mac UTC date\n          = 64-bit unsigned value in seconds since beginning 1904</code></pre></div>\n<p>Boom, we just need to read the 1 byte version number to either read 4 bytes or 8 bytes from the <code class=\"language-text\">mvhd</code> location. </p>\n<p><code class=\"language-text\">mvhd</code> in hex is <code class=\"language-text\">6d 76 68 64</code></p>\n<p>Let us look back at the file and break it down byte for byte.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">                          m  v h  d \n                          -- ~~== ##_ &lt;-- version byte\n                                      - -- &lt;-- skip these 3, flags not needed\n                                          -- -- &lt;-- these 4 bytes for the time.\n0100b80: 6f6f 7600 0000 6c6d 7668 6400 0000 007c  oov...lmvhd....|</code></pre></div>\n<p>You can see the time for this video is <code class=\"language-text\">0000</code> in long unsigned value in seconds since beginning 1904 to 2040. Meaning this video was created 1904 but that wasn't true so what this means is the video does not have a creation time. It has the default value of 0 seconds. This is how we want to read the bytes of the mp4 to get the creation time.</p>\n<p>After we get the seconds we need to convert the Mac HFS+ timestamp in seconds to current Unix timestamp then to current human date time. This website describes the conversion for us <a href=\"https://www.epochconverter.com/mac\">https://www.epochconverter.com/mac</a></p>\n<h3>Implementation outline</h3>\n<ul>\n<li>Read file from desktop through file reader</li>\n<li>Stream the contents of the File</li>\n<li>While stream reading the contents look for <code class=\"language-text\">mvhd</code></li>\n<li>Once mvhd is found, parse the seconds</li>\n<li>Convert Mac HFS+ seconds → unix seconds → human readable ISO string</li>\n<li>You now have a creation date for a mp4 video in client side javascript</li>\n</ul>\n<p>Parameters</p>\n<ul>\n<li>chunk size</li>\n<li>stream from back</li>\n<li>stream from front</li>\n<li>max bytes read</li>\n</ul>\n<h2>Let us begin!</h2>\n<p>We want to read the File/ Blob into an Uint8 array for we have a byte representation of our original file. We don't want to work with a File or Blob data type to do this parsing. We need to read the File/Blob into its bytes. Easiest way of doing this is using a file reader to convert the File into an array buffer and from array buffer into Uint8Array</p>\n<p>File or Blob → File reader → Read as arraybuffer → Result → Convert result into Uint8Array</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * Converts a file or blob into an unsigned integers of 8 bytes array. \n * @param {(File | Blob)} file \n * @return {Uint8Array}\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">FileBlobToUint8Array</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsArrayBuffer</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Once we have a Uint8Array of the chunk we need to do some conversion to read for <code class=\"language-text\">mvhd</code> because we cannot just search the Uint8Array for the string characters <code class=\"language-text\">mvhd</code>. </p>\n<p>Take a look at the hex values again</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0100b80: 6f6f 7600 0000 6c6d 7668 6400 0000 007c  oov...lmvhd....|</code></pre></div>\n<p>Instead of reading and searching for the hex version of this how about we convert this to char's and do a substring search. </p>\n<p>Given a chunk of bytes you can convert them to char's with javascript's <code class=\"language-text\">String.prototype.fromCharCode</code> function. Since we actually converted the array to Uint8Array we will be converting the Uint8Array values to the char. </p>\n<p><code class=\"language-text\">6d in hex</code> == <code class=\"language-text\">109 in decimal</code> == <code class=\"language-text\">m in char</code></p>\n<p>If we do this for every decimal value we will get a string version of the chunk. Once we have a string version of the chunk we can do <code class=\"language-text\">charString.indexOf(&#39;mvhd&#39;)</code> and it will give us the index where the string <code class=\"language-text\">mvhd</code> begins within the chunk (not in terms of the total file, we will have to compute this index later). </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n  * Convert an array of unsigned integers of 8 bytes into a string of chars.\n  * This will convert each decimal value to a char and concat all the chars\n  * together to form the string.\n  * @param {Uint8Array} byteArray \n  * @param {String} string representation of the original byte array\n  */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">uint8ToCharCodeString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byteArray</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>byteArray<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The reason I go from hex to decimal to char is that I can easily search the atom's in the mp4 file for the beginning of the atom that I need. Once I know the absolute index of <code class=\"language-text\">mvhd</code> in the original file I can easily read the next few bytes after to get the creation time. </p>\n<p>Here is a snippet to show you what I mean,</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Code snippet, full code will be below.</span>\n<span class=\"token comment\">// ...</span>\n<span class=\"token comment\">// within an iteration</span>\n<span class=\"token keyword\">const</span> chunk <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end <span class=\"token operator\">+</span> strLengthEdgeCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// File </span>\n<span class=\"token keyword\">const</span> uint8Chunk <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">FileBlobToUint8Array</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Uin8Array</span>\n<span class=\"token keyword\">const</span> charCodeString <span class=\"token operator\">=</span> <span class=\"token function\">uint8ToCharCodeString</span><span class=\"token punctuation\">(</span>uint8Chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// String</span>\n\nindexOfStr <span class=\"token operator\">=</span> charCodeString<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// str would be 'mvhd'</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>indexOfStr <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Since we are reading backwards from the end of the file read, compute</span>\n  <span class=\"token comment\">// the global file index of where the str begins</span>\n  globalFileIndex <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">*</span> chunkSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> indexOfStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Here is our logic within a loop.</p>\n<ol>\n<li>Slice original file into a chunk</li>\n<li>Convert chunk to Uint8Array chunk</li>\n<li>Convert the decimal values to char's</li>\n<li>Search the char string for <code class=\"language-text\">mvhd</code> and retrieve the index within the chunk</li>\n<li><code class=\"language-text\">GOTO</code> step 1 if <code class=\"language-text\">mvhd</code> is not found in this chunk else continue to step 6</li>\n<li>Compute the absolute index within the original file where <code class=\"language-text\">mvhd</code> begins</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * Reads a file backwards to find the index of the str you are searching for\n * i.g. you can search for moov, mvhd, etc...\n * @param {(File | Blob)} file \n * @param {String} str - String contents you are trying to search in the file\n * @param {*} defaultChunkSize \n * @param {*} maxBytesRead \n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">readFileByChunksBackwardsForStringIndex</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">,</span> defaultChunkSize<span class=\"token operator\">=</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">,</span> maxBytesRead<span class=\"token operator\">=</span><span class=\"token number\">100000000</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> chunkSize <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">&lt;</span> defaultChunkSize <span class=\"token operator\">?</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">:</span> defaultChunkSize \n  <span class=\"token keyword\">let</span> iteration <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> start <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> end <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> iteration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> indexOfStr <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> globalFileIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> strLengthEdgeCase <span class=\"token operator\">=</span> str<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// read backwards</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>end <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">*</span> chunkSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> maxBytesRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    start <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    start <span class=\"token operator\">=</span> start <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> start<span class=\"token punctuation\">;</span>\n    end <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> iteration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// since we are reading by a random chunk size we have a few edge conditions to worry about</span>\n    <span class=\"token comment\">// chunk bounds</span>\n    <span class=\"token keyword\">const</span> chunk <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end <span class=\"token operator\">+</span> strLengthEdgeCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> uint8Chunk <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">FileBlobToUint8Array</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> charCodeString <span class=\"token operator\">=</span> <span class=\"token function\">uint8ToCharCodeString</span><span class=\"token punctuation\">(</span>uint8Chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    indexOfStr <span class=\"token operator\">=</span> charCodeString<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>indexOfStr <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Since we are reading backwards from the end of the file read, compute</span>\n      <span class=\"token comment\">// the global file index of where the str begins</span>\n      globalFileIndex <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">*</span> chunkSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> indexOfStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    iteration<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> globalFileIndex<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Once we have the index we can go to the global position in the original file to help us parse the data. If scroll back up to the mp4 byte definition after the <code class=\"language-text\">mvhd</code> you can see we need to parse the version for <code class=\"language-text\">0</code> or <code class=\"language-text\">1</code> to read 4 or 8 bytes for the creation time.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * Retrieves the creation time of the mp4 video\n * @param {(File | Blob)} file \n * @return {(String | null)} a date time iso string of the creation time or null\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCreationTime</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> globalFileIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">readFileByChunksBackwardsForStringIndex</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'mvhd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>globalFileIndex<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// global file index points the start of m in mvhd, lets move it 4 bytes past this str name</span>\n  <span class=\"token comment\">// now it will point at the version</span>\n  <span class=\"token keyword\">const</span> parsingIndex <span class=\"token operator\">=</span> globalFileIndex <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// move it 12 bytes ahead to parse either version of the creation time</span>\n  <span class=\"token comment\">// 4 for version + flags</span>\n  <span class=\"token comment\">// 8 for the creation time</span>\n  <span class=\"token comment\">// 12 in total</span>\n  <span class=\"token keyword\">const</span> fileChunk <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>parsingIndex<span class=\"token punctuation\">,</span> globalFileIndex <span class=\"token operator\">+</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> uInt8Chunk <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">FileBlobToUint8Array</span><span class=\"token punctuation\">(</span>fileChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> creationTime <span class=\"token operator\">=</span> <span class=\"token function\">parseBytesAfterMvhd</span><span class=\"token punctuation\">(</span>uInt8Chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> creationTime<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To read the creation time it is quite simple, you just read and convert the bytes after the you know the location of <code class=\"language-text\">mvhd</code></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * Reads the bytes after the mvhd str to parse the creation date only. \n * \n * 8+ bytes movie (presentation) header box\n *    = long unsigned offset + long ASCII text string 'mvhd'\n *  -> 1 byte version = 8-bit unsigned value\n *    - if version is 1 then date and duration values are 8 bytes in length\n *  -> 3 bytes flags =  24-bit hex flags (current = 0)\n *\n *  -> 4 bytes created mac UTC date\n *      = long unsigned value in seconds since beginning 1904 to 2040\n *  -> 4 bytes modified mac UTC date\n *      = long unsigned value in seconds since beginning 1904 to 2040\n *  OR\n *  -> 8 bytes created mac UTC date\n *      = 64-bit unsigned value in seconds since beginning 1904\n *  -> 8 bytes modified mac UTC date\n *      = 64-bit unsigned value in seconds since beginning 1904\n * @param {Uint8Array} uInt8Chunk \n * @return {(String | null)} ISO Datetime string or null if no creation date\n * was found \n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">parseBytesAfterMvhd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">uInt8Chunk</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> version <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>uInt8Chunk<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> seconds <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// read the 4 byte creation time</span>\n    <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 byte for version, 3 bytes of flags</span>\n    <span class=\"token keyword\">const</span> end <span class=\"token operator\">=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// offset from the start for the 4 bytes of creation time</span>\n    <span class=\"token keyword\">const</span> createdBytes <span class=\"token operator\">=</span> uInt8Chunk<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    seconds <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>createdBytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// read the 8 creation time</span>\n    <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 byte for version, 3 bytes of flags</span>\n    <span class=\"token keyword\">const</span> end <span class=\"token operator\">=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// offset from the start for the 8 bytes of creation time</span>\n    <span class=\"token keyword\">const</span> createdBytes <span class=\"token operator\">=</span> uInt8Chunk<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    seconds <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>createdBytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> seconds <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> <span class=\"token function\">macHFSPlusToISOString</span><span class=\"token punctuation\">(</span>seconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Once we parse the seconds we can convert it from Mac HFS+ to date time ISO string. </p>\n<p>And that is it, we got the creation time of a mp4 in the frontend via slicing &#x26; streaming the file through a file reader, converter &#x26; parser. I am not going to talk about implementing more of the other features like searching from front of the file or setting up more configuration. This is enough of a staring point for people and to get my point across. The code will work as is.</p>\n<p>I will be updating the code with new features and configuration settings within this github repo <a href=\"https://github.com/nadr0/mp4-metadata\">https://github.com/nadr0/mp4-metadata</a>. You can find it on NPM as well <a href=\"https://www.npmjs.com/package/mp4-metadata\">https://www.npmjs.com/package/mp4-metadata</a>  </p>\n<p>Here is all the code together,</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// entry is</span>\n<span class=\"token keyword\">await</span> <span class=\"token function\">getCreationTime</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/**\n * Converts a file or blob into an unsigned integers of 8 bytes array. \n * @param {(File | Blob)} file \n * @return {Uint8Array}\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">FileBlobToUint8Array</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    \n    reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsArrayBuffer</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * seconds in Mac HFS+ to be converted into a date time iso string\n * @param {Number} seconds - Mac HFS+ seconds\n * @return {String} date time iso string\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">macHFSPlusToISOString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">seconds</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// offset seconds and multipled by 1000 to use seconds in javascript date.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>seconds <span class=\"token operator\">-</span> <span class=\"token number\">2082844800</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Convert an array of bytes into a hex string\n * @param {Uint8Array} byteArray \n * @param {String} hex version of the original byte array\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">toHexString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byteArray</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>byteArray<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'0'</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>byte <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Converts a string of hex values into its decimal representation\n * @param {String} hexString \n * @param {Number} decimal version of the hex string\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">toDecimalFromHexString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">hexString</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>hexString<span class=\"token punctuation\">,</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Convert an array of unsigned integers of 8 bytes into a string of chars.\n * This will convert each decimal value to a char and concat all the chars\n * together to form the string.\n * @param {Uint8Array} byteArray \n * @param {String} string representation of the original byte array\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">uint8ToCharCodeString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byteArray</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>byteArray<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">byte</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">(</span>byte<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">/**\n * Reads the bytes after the mvhd str to parse the creation date only. \n * \n * 8+ bytes movie (presentation) header box\n *    = long unsigned offset + long ASCII text string 'mvhd'\n *  -> 1 byte version = 8-bit unsigned value\n *    - if version is 1 then date and duration values are 8 bytes in length\n *  -> 3 bytes flags =  24-bit hex flags (current = 0)\n *\n *  -> 4 bytes created mac UTC date\n *      = long unsigned value in seconds since beginning 1904 to 2040\n *  -> 4 bytes modified mac UTC date\n *      = long unsigned value in seconds since beginning 1904 to 2040\n *  OR\n *  -> 8 bytes created mac UTC date\n *      = 64-bit unsigned value in seconds since beginning 1904\n *  -> 8 bytes modified mac UTC date\n *      = 64-bit unsigned value in seconds since beginning 1904\n * @param {Uint8Array} uInt8Chunk \n * @return {(String | null)} ISO Datetime string or null if no creation date\n * was found \n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">parseBytesAfterMvhd</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">uInt8Chunk</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> version <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>uInt8Chunk<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> seconds <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// read the 4 byte creation time</span>\n    <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 byte for version, 3 bytes of flags</span>\n    <span class=\"token keyword\">const</span> end <span class=\"token operator\">=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// offset from the start for the 4 bytes of creation time</span>\n    <span class=\"token keyword\">const</span> createdBytes <span class=\"token operator\">=</span> uInt8Chunk<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    seconds <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>createdBytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>version <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// read the 8 creation time</span>\n    <span class=\"token keyword\">const</span> start <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1 byte for version, 3 bytes of flags</span>\n    <span class=\"token keyword\">const</span> end <span class=\"token operator\">=</span> start <span class=\"token operator\">+</span> <span class=\"token number\">8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// offset from the start for the 8 bytes of creation time</span>\n    <span class=\"token keyword\">const</span> createdBytes <span class=\"token operator\">=</span> uInt8Chunk<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    seconds <span class=\"token operator\">=</span> <span class=\"token function\">toDecimalFromHexString</span><span class=\"token punctuation\">(</span><span class=\"token function\">toHexString</span><span class=\"token punctuation\">(</span>createdBytes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> seconds <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">:</span> <span class=\"token function\">macHFSPlusToISOString</span><span class=\"token punctuation\">(</span>seconds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Reads a file backwards to find the index of the str you are searching for\n * i.g. you can search for moov, mvhd, etc...\n * @param {(File | Blob)} file \n * @param {String} str - String contents you are trying to search in the file\n * @param {*} defaultChunkSize \n * @param {*} maxBytesRead \n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">readFileByChunksBackwardsForStringIndex</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file<span class=\"token punctuation\">,</span> str<span class=\"token punctuation\">,</span> defaultChunkSize<span class=\"token operator\">=</span><span class=\"token number\">1000000</span><span class=\"token punctuation\">,</span> maxBytesRead<span class=\"token operator\">=</span><span class=\"token number\">100000000</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> chunkSize <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">&lt;</span> defaultChunkSize <span class=\"token operator\">?</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">:</span> defaultChunkSize \n  <span class=\"token keyword\">let</span> iteration <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> start <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> end <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> iteration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> indexOfStr <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> globalFileIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> strLengthEdgeCase <span class=\"token operator\">=</span> str<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// read backwards</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>end <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">*</span> chunkSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> maxBytesRead<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    start <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    start <span class=\"token operator\">=</span> start <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">?</span> <span class=\"token number\">0</span> <span class=\"token operator\">:</span> start<span class=\"token punctuation\">;</span>\n    end <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">*</span> iteration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// since we are reading by a random chunk size we have a few edge conditions to worry about</span>\n    <span class=\"token comment\">// chunk bounds</span>\n    <span class=\"token keyword\">const</span> chunk <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span> end <span class=\"token operator\">+</span> strLengthEdgeCase<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> uint8Chunk <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">FileBlobToUint8Array</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> charCodeString <span class=\"token operator\">=</span> <span class=\"token function\">uint8ToCharCodeString</span><span class=\"token punctuation\">(</span>uint8Chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    indexOfStr <span class=\"token operator\">=</span> charCodeString<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>indexOfStr <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Since we are reading backwards from the end of the file read, compute</span>\n      <span class=\"token comment\">// the global file index of where the str begins</span>\n      globalFileIndex <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>iteration <span class=\"token operator\">*</span> chunkSize<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>chunkSize <span class=\"token operator\">-</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> indexOfStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    iteration<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> globalFileIndex<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n * Retrieves the creation time of the mp4 video\n * @param {(File | Blob)} file \n * @return {(String | null)} a date time iso string of the creation time or null\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCreationTime</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">file</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> globalFileIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">readFileByChunksBackwardsForStringIndex</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'mvhd'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>globalFileIndex<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// global file index points the start of m in mvhd, lets move it 4 bytes past this str name</span>\n  <span class=\"token comment\">// now it will point at the version</span>\n  <span class=\"token keyword\">const</span> parsingIndex <span class=\"token operator\">=</span> globalFileIndex <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// move it 12 bytes ahead to parse either version of the creation time</span>\n  <span class=\"token comment\">// 4 for version + flags</span>\n  <span class=\"token comment\">// 8 for the creation time</span>\n  <span class=\"token comment\">// 12 in total</span>\n  <span class=\"token keyword\">const</span> fileChunk <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>parsingIndex<span class=\"token punctuation\">,</span> globalFileIndex <span class=\"token operator\">+</span> <span class=\"token number\">12</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> uInt8Chunk <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">FileBlobToUint8Array</span><span class=\"token punctuation\">(</span>fileChunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> creationTime <span class=\"token operator\">=</span> <span class=\"token function\">parseBytesAfterMvhd</span><span class=\"token punctuation\">(</span>uInt8Chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> creationTime<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"date":"April 01, 2020","path":"/blog/parsing-creation-time-from-mp4-metadata-in-javascript","title":"Parsing creation time of ISO 14496-1 Media Format aka MP4 in javascript","categories":["Code"],"tags":["mp4","javascript","optimiziations","npm package"]}}},"pageContext":{}}}